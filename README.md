# 生态棚室自控系统


## 引言

"生态棚室自控系统"是基于农业大棚模型建立的自动调节系统。项目本身的代码实现比较简单，这里采用的是Python+C混合的方式，但是并不涉及两者之间的调用。事实上现在只有一个Python代码文件，即利用爬虫获取‘墨迹天气’的天气信息的 WeatherForecast.py。

项目是运行于树莓派这一平台的，这里使用的树莓派是Raspberry Pi3 B版。因为操作GPIO的代码是使用C语言写的，所采用的引脚定义方式自然就是wiringPi方式。如果想要移植到其他版本的树莓派或者使用别的语言操作GPIO，请根据实际情况修改引脚定义方式。

### 效果图
![效果图](https://github.com/tianlei124/Greenhouse-automatic-control-system/raw/master/photos/效果图.JPG)


## (传感器&动作模块)的引脚对应表
|    传感器        | wiringPi| BCM         | BOARD |
| ---------------- | :-----: | :---------: | ----: |
|DHT11温、湿度传感器|    7    |  4          |  7    |
|  继电器(IN1,IN2)  | (22,21) |    (6,5)   | (31,29) |
| 土壤湿度传感器    |    6    |  25        |   22  |
|    光强传感器    |    3    | 22          |   15  |
|    补光灯        |    1    | 18          |   12  |
|ULN2003(IN1~IN4)|(0,5,2,4)|(17,24,27,23)|(11,18,13,16)|


## （传感器&动作模块）驱动方法

### DHT11温度、湿度传感器（摘自DHT11 datasheet）

#### 引脚说明
* VDD 供电3.3～5.5V
* DATA 串行数据，单总线
* GND 接地/电源负极

#### 串行通信

DATA用于微处理器和DHT11之间的通讯和同步，采用单总线数据格式，一次传输40bit数据，高位先出。

#### 数据格式
8bit湿度证书数据+8bit湿度小数数据+8bit温度整数数据+8bit温度小数数据+8bit校验位
注：（其中温、湿度小数部分为0...其实我也不太懂为什么这么做）

校验位数据定义：
8bit湿度证书数据+8bit湿度小数数据+8bit温度整数数据+8bit温度小数数据 = 8bit校验位

#### 外设读取步骤
主机和从机之间的通信可通过如下几个步骤完成


**步骤一:**
DHT11 上电后（DHT11 上电后要等待 1S 以越过不稳定状态,在此期间不能发送任何指令），测试环境温湿度数据，并记录数据，同时 DHT11 的 DATA 数据线由上拉电阻拉高一直保持高电平；此时 DHT11 的DATA 引脚处于输入状态，时刻检测外部信号。

**步骤二:**
微处理器的 I/O 设置为输出同时输出低电平(实际上，应该在设置为输出之后先配置为高电平在配置为低电平，要体现出来由高变低的边沿)，且低电平保持时间不能小于 18ms，然后微处理器的 I/O设置为输入状态，由于上拉电阻，微处理器的 I/O 即 DHT11 的 DATA 数据线也随之变高，等待 DHT11 作出回答信号

**步骤三:**
DHT11 的 DATA 引脚检测到外部信号有低电平时，等待外部信号低电平结束，延迟后 DHT11 的 DATA引脚处于输出状态，输出 80 微秒的低电平作为应答信号，紧接着输出 80 微秒的高电平通知外设准备接收数据，微处理器的 I/O 此时处于输入状态，检测到 I/O 有低电平（DHT11 回应信号）后，等待 80 微秒的高电平后接收数据。接收每一位数据前都有80微妙的准备时间

**步骤四：**
由 DHT11 的 DATA 引脚输出 40 位数据，微处理器根据 I/O 电平的变化接收 40 位数据，位数据“ 0”的格式为： 50 微秒的低电平和 26-28 微秒的高电平，位数据“ 1”的格式为： 50 微秒的低电平加 70微秒的高电平。

结束信号:
DHT11 的 DATA 引脚输出 40 位数据后，继续输出低电平 50 微秒后转为输入状态，由于上拉电阻随
之变为高电平。但 DHT11 内部重测环境温湿度数据，并记录数据，等待外部信号的到来。


### 土壤湿度传感器

使用方法是将土壤湿度探头插进土壤里面（插深点）就可以了。在土壤湿度达到设定值时，其DO口就会输出低电平。这个土壤湿度传感器实在是够简单，连模拟输出口都没有，所以只能傻瓜式的使用。检测到DO口输出低电平后，对继电器的IN1口输出低电平。之所以没有将传感器的DO口同继电器的IN1直接连接起来，是因为需要将采集到的土壤湿度信息记录下来。


### 光强传感器

使用方法是...按照要求把引脚连好就行了。同上面的土壤湿度的传感器一样，这个传感器的使用也十分傻瓜式，同样也不具备模拟输出功能。不过好在与其相光的补光灯我已经使用了PWM输出方式，所以这里就是没有模拟输出也没关系。这个传感器所采集到的信息，同样会被记录下来。光强传感器同上面的土壤湿度传感器一样，要想调节设定值，只能通过调节电位器来实现（不得不说，有点操蛋）。


### ULN2003&步进电机

这个步进电机用来是关闭/打开窗帘的。这里所采用的步进电机是28BYJ-48，用ULN2003驱动的话，居然连3r/min都达不到...
使用ULN2003驱动步进电机其实非常简单，如果使用四步一周的方式的话，加电顺序是A-B-C-D，使用八步一周的话则是A-AB-B-BC-C-CD-D-DA.28BYJ-48步进电机只有这两种方。
关于步进电机的使用方式这里不展开叙述，可以通过百度“ULN2003驱动28BYJ-48”来获得这些知识。


### 补光灯

暂时使用一个普通的LED灯代替，将它放在光强传感器的感光元件附近。当（环境光+LED光）小于光强传感器设定值时，LED逐渐变亮（这也是为什么会将其接在GPIO1的缘故，因为要用到GPIO1的PWM输出功能）。


### 二路继电器
只是普通的具有两个输入口的继电器，其中IN1根据土壤湿度传感器的测量值，驱动灌溉设备；IN2根据DHT11温、湿度传感器的测量值，驱动加热设备。之所以并没有像补光灯那样使用PWM输出，是考虑无论是灌溉还是加热，都难以实时控制，使用PWM输出并没有什么意义。